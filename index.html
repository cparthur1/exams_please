<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="icon.jpg">
    <title>Exams, Please - beta 1</title>
    <style>
        :root {
            --bg-color: #2b3026;
            --desk-color: #1e221b;
            --paper-color: #dcdcdc;
            --accent-red: #8f4440;
            --accent-green: #5a7d5a;
            --terminal-text: #33ff00;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--paper-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- TELAS (STATES) --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }
        
        .active { display: flex; }

        /* TELA 1: LOGIN API */
        #start-screen {
            background: #111;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .login-box {
            border: 2px solid var(--accent-green);
            padding: 40px;
            text-align: center;
            background: #000;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .api-link {
            color: #aaa;
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 5px;
        }
        .api-link:hover { color: #fff; }
        
        /* TELA 2: LOADING */
        #loading-screen {
            background: rgba(0,0,0,0.95);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 90;
            color: var(--terminal-text);
        }
        .loader {
            border: 8px solid #333;
            border-top: 8px solid var(--terminal-text);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* TELA 3: JOGO (INTERFACE ORIGINAL) */
        #game-screen {
            flex-direction: column;
            z-index: 1;
        }

        /* --- COMPONENTES DO JOGO --- */
        
        /* Top Bar */
        #status-bar {
            background: #111;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #000;
            font-size: 0.9rem;
        }

        #game-area {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Left: Viewport (Patient) */
        #viewport {
            flex: 1;
            background: #4a5045;
            border-right: 4px solid #111;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
        }

        .patient-sprite {
            width: 220px;
            height: 280px;
            background: #000;
            mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="20"/><rect x="15" y="55" width="70" height="50" /></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="30" r="20"/><rect x="15" y="55" width="70" height="50" /></svg>');
            background-color: #8b9bb4; 
            position: relative;
            margin-bottom: -40px;
            z-index: 1;
        }
        
        #admission-doc {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            background: #f0f0f0;
            color: #000;
            padding: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.7);
            font-size: 0.75rem;
            transform: rotate(-2deg);
            z-index: 10;
            border: 1px solid #999;
            opacity: 0.95;
        }
        #admission-doc h3 {
            font-size: 0.9rem;
            border-bottom: 1px solid #000;
            margin-bottom: 5px;
        }

        #patient-dialogue {
            background: #000;
            color: #fff;
            width: 100%;
            padding: 15px;
            text-align: center;
            border-top: 4px solid #333;
            min-height: 80px;
            font-style: italic;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            position: relative;
        }

        #desk {
            flex: 1.6;
            background: var(--desk-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        #log-area {
            background: #111;
            color: var(--terminal-text);
            flex: 1;
            min-height: 200px;
            padding: 10px;
            font-size: 0.9rem;
            overflow-y: auto;
            border: 2px inset #555;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .log-user { color: #fff; font-weight: bold; border-top: 1px solid #333; margin-top: 5px; padding-top: 5px;}
        .log-sys { color: #aaa; font-style: italic; }
        .log-error { color: #ff5555; font-weight: bold; }
        .log-retry { color: #ffff00; font-size: 0.7rem; }

        input, select, textarea {
            width: 96%;
            padding: 10px;
            margin-bottom: 8px;
            background: #000;
            color: #fff;
            border: 1px solid #555;
            font-family: var(--font-main);
        }

        textarea { resize: vertical; height: 60px; }

        button {
            background: var(--paper-color);
            border: 2px solid #000;
            padding: 10px 16px;
            font-weight: bold;
            font-family: var(--font-main);
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { background: #fff; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-finish {
            background: var(--accent-red);
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        /* Modal Diagnostico */
        #diag-modal {
            display: none;
            background: #222;
            padding: 20px;
            border: 2px solid #fff;
            margin-top: 10px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            z-index: 100;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }

        /* TELA 4: REPORT (OVERLAY) */
        #report-screen {
            background: rgba(0,0,0,0.95);
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        #report-paper {
            background: #f4f4f4;
            color: #000;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            border: 1px solid #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .report-section {
            border-bottom: 1px dashed #999;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        h2, h3 { margin-top: 0; text-transform: uppercase; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- TELA 1: LOGIN -->
    <div id="start-screen" class="screen active">
        <div class="login-box">
            <h1 style="color:white; margin-top:0;">Exams, Please</h1>
            <p style="color:#aaa; font-size:0.9rem;">Insira sua credencial para iniciar o plant√£o. (Gemini API Key)</p>
            
            <input type="password" id="api-key-input" placeholder="Cole sua API Key aqui">
            <button onclick="startShift()" style="width:100%;">INICIAR PLANT√ÉO</button>
            
            <a href="https://aistudio.google.com/api-keys" target="_blank" class="api-link">N√£o tenho chave da API (Gerar Gr√°tis)</a>
            
            <p style="font-size:0.7rem; color:#666; margin-top:10px;">Modelo: gemini-flash-latest</p>
        </div>
    </div>

    <!-- TELA 2: LOADING -->
    <div id="loading-screen" class="screen">
        <div class="loader"></div>
        <h2 id="loading-text">GERANDO CASO CL√çNICO...</h2>
        <div id="loading-details" style="font-size:0.8rem; color:#888; margin-top:10px;">Consultando banco de dados de patologias...</div>
    </div>

    <!-- TELA 3: JOGO -->
    <div id="game-screen" class="screen">
        <div id="status-bar">
            <span>PLANTONISTA: DR(A). ESTUDANTE</span>
            <span>CASO: <span id="case-id">#000</span></span>
        </div>

        <div id="game-area">
            <!-- Paciente -->
            <div id="viewport">
                <!-- Ficha movida para c√° (Overlay) -->
                <div id="admission-doc">
                    <h3>Ficha de Admiss√£o</h3>
                    <p id="doc-patient-info">Carregando...</p>
                    <p id="doc-vitals">Carregando...</p>
                    <p style="font-size:0.7rem; color:#555;">*Triagem realizada pela enfermagem*</p>
                </div>

                <div class="patient-sprite"></div>
                <div id="patient-dialogue">...</div>
            </div>

            <!-- Mesa -->
            <div id="desk">
                <!-- Log -->
                <div id="log-area"></div>

                <!-- Controles -->
                <div id="controls">
                    <label>A√á√ÉO / PERGUNTA:</label>
                    <input type="text" id="input-action" placeholder="Ex: Examinar abdome / Tem febre? / Hemograma">
                    
                    <label>JUSTIFICATIVA (Obrigat√≥rio):</label>
                    <input type="text" id="input-justification" placeholder="Justifique (economize recursos p√∫blicos)">
                    
                    <button id="btn-exec" onclick="performAction()" style="width:100%;">EXECUTAR</button>
                </div>

                <button class="btn-finish" onclick="openDiagModal()">üìù CONCLUIR ATENDIMENTO</button>
            </div>
        </div>

        <!-- Modal Diagn√≥stico -->
        <div id="diag-modal">
            <h3 style="color:white; margin-top:0; border-bottom:1px solid #555; padding-bottom:10px;">PRONTU√ÅRIO FINAL</h3>
            
            <label style="color:#aaa; font-size:0.8rem;">1. HIP√ìTESE DIAGN√ìSTICA:</label>
            <input type="text" id="final-diag" placeholder="Ex: Apendicite Aguda">

            <label style="color:#aaa; font-size:0.8rem;">2. JUSTIFICATIVA / RACIOC√çNIO CL√çNICO:</label>
            <textarea id="final-just" placeholder="Por que voc√™ chegou a este diagn√≥stico? Quais achados confirmam?"></textarea>

            <label style="color:#aaa; font-size:0.8rem;">3. CONDUTA TERAP√äUTICA:</label>
            <input type="text" id="final-conduta" placeholder="Ex: Interna√ß√£o, Cirurgia, Analgesia...">

            <button onclick="submitCase()" style="width:100%; background: #fff; color:#000; margin-top:15px;">ASSINAR E ENVIAR</button>
            <button onclick="closeDiagModal()" style="width:100%; background: transparent; color:#aaa; border:none; margin-top:5px; font-size:0.8rem;">Cancelar / Voltar</button>
        </div>
    </div>

    <!-- TELA 4: RELAT√ìRIO -->
    <div id="report-screen" class="screen">
        <div id="report-paper">
            <h1 style="text-align:center; border-bottom:4px solid #000; padding-bottom:10px;">AUDITORIA M√âDICA</h1>
            <div id="report-content">
                <!-- Preenchido via JS -->
            </div>
            <button onclick="nextCase()" style="width:100%; margin-top:20px; background:#000; color:#fff; padding: 15px; font-size: 1.1rem;">PR√ìXIMO PACIENTE >></button>
        </div>
    </div>

<script>
    // --- CONFIGURA√á√ÉO ---
    let apiKey = "";
    const MODEL_NAME = "gemini-flash-latest"; 
    
    // --- ESTADO ---
    let currentCase = null; 
    let chatHistory = [];   
    let caseCount = 0;

    // --- ELEMENTOS ---
    const screens = {
        start: document.getElementById('start-screen'),
        loading: document.getElementById('loading-screen'),
        game: document.getElementById('game-screen'),
        report: document.getElementById('report-screen')
    };

    // --- 1. INICIALIZA√á√ÉO ---

    function switchScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name].classList.add('active');
    }

    function startShift() {
        const inputKey = document.getElementById('api-key-input').value.trim();
        if(!inputKey) {
            alert("Insira a chave API.");
            return;
        }
        apiKey = inputKey;
        generateNewCase();
    }

    // --- 2. GERA√á√ÉO DE CASO (IA) ---

    async function generateNewCase() {
        switchScreen('loading');
        caseCount++;
        document.getElementById('case-id').innerText = `#${String(caseCount).padStart(3, '0')}`;
        document.getElementById('loading-text').innerText = "ADMITINDO PACIENTE...";
        
        chatHistory = [];
        document.getElementById('log-area').innerHTML = "";
        document.getElementById('patient-dialogue').innerText = "...";
        document.getElementById('input-action').value = "";
        document.getElementById('input-justification').value = "";
        
        document.getElementById('final-diag').value = "";
        document.getElementById('final-just').value = "";
        document.getElementById('final-conduta').value = "";
        
        closeDiagModal();

        // Prompt REFORMULADO para m√°xima criatividade e inclus√£o de casos variados
        const prompt = `
            Atue como um gerador de casos cl√≠nicos para simula√ß√£o m√©dica.
            
            BANCO DE IDEIAS (POOL) - Escolha UMA patologia aleatoriamente:
            - COTIDIANO (UBS): Hipertens√£o (Crise ou Descontrole), DM2 (Cetoacidose ou P√© diab√©tico), Infec√ß√£o Urin√°ria (Cistite ou Pielonefrite), Gastroenterite Viral, Dengue (com ou sem sinais de alarme), Lombalgia Mec√¢nica, Dermatite de Contato, Ansiedade Generalizada.
            - CARDIO/RESP: Insufici√™ncia Card√≠aca (ICFER), Fibrila√ß√£o Atrial, Asma (Crise), DPOC Exacerbado, Pneumonia Comunit√°ria, Pneumot√≥rax Espont√¢neo, TEP (Tromboembolismo Pulmonar).
            - ABDOME/CIRURGIA: Apendicite Aguda, Colecistite, Pancreatite, Obstru√ß√£o Intestinal, Diverticulite, H√©rnia Inguinal Encarcerada.
            - NEURO: Cefaleia Tensional, Enxaqueca, AVC (Isqu√™mico ou Hemorr√°gico), VPPB (Labirintite), Meningite Viral/Bacteriana.
            - INFECTO/PARASITO: Tuberculose Pulmonar, S√≠filis Secund√°ria, Leptospirose, Mal√°ria (importada ou n√£o), Hansen√≠ase, Escabiose, COVID-19.
            - TRAUMA/EXTERNO: Entorse de Tornozelo, Fratura de R√°dio Distal, Queimadura de 2¬∫ Grau, TCE Leve (Concuss√£o).
            - RAROS/ZEBRAS: S√≠ndrome de Guillain-Barr√©, Doen√ßa de Kawasaki, P√∫rpura de Henoch-Sch√∂nlein, Botulismo, Feocromocitoma, L√∫pus (LES).

            ESTRUTURA JSON OBRIGAT√ìRIA:
            {
                "patient": {
                    "name": "Nome Completo", "age": "Idade", "gender": "G√™nero", "job": "Profiss√£o",
                    "visual_appearance": "Descri√ß√£o visual (ex: dispneico, corado, emagrecido)",
                    "personality": "Personalidade (ex: teimoso, prolixo, assustado, hostil)"
                },
                "triage": {
                    "chief_complaint": "Queixa Principal (em linguagem leiga)",
                    "vitals": "PA, FC, FR, Temp, SatO2, Destro (se necess√°rio)"
                },
                "hidden_truth": {
                    "history_hpi": "HDA detalhada (termos m√©dicos)",
                    "history_social": "Hist√≥rico Social/Familiar/H√°bitos",
                    "physical_exam": "Exame F√≠sico completo (dados positivos e negativos pertinentes)",
                    "labs_and_imaging": "Resultados de exames esperados para este caso (se houver indica√ß√£o)",
                    "diagnosis": "Diagn√≥stico Definitivo",
                    "pathophysiology": "Fisiopatologia resumida"
                }
            }
            Retorne APENAS o JSON, sem markdown.
        `;

        try {
            const result = await callGeminiAPI(prompt, true); 
            const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
            currentCase = JSON.parse(cleanJson);
            
            setupGameUI();
            switchScreen('game');
            initializeChatContext();

        } catch (e) {
            console.error(e);
            alert("Erro cr√≠tico ao gerar caso: " + e.message + ". Tentando novamente...");
            setTimeout(() => { if(confirm("Tentar gerar novamente?")) generateNewCase(); }, 1000);
        }
    }

    function setupGameUI() {
        const p = currentCase.patient;
        const t = currentCase.triage;
        
        document.getElementById('doc-patient-info').innerHTML = `<strong>Nome:</strong> ${p.name}<br><strong>Idade:</strong> ${p.age} | <strong>Ocup:</strong> ${p.job}`;
        document.getElementById('doc-vitals').innerHTML = `<strong>QP:</strong> "${t.chief_complaint}"<br><strong>Sinais:</strong> ${t.vitals}`;
        document.getElementById('patient-dialogue').innerText = `"${t.chief_complaint}"`;
    }

    function initializeChatContext() {
        chatHistory = [
            {
                role: "user",
                parts: [{ text: `
                    SYSTEM INSTRUCTION:
                    Voc√™ √© o motor de um simulador m√©dico "Papers, Please". Duas personas:
                    
                    1. O PACIENTE (${currentCase.patient.name}): 
                       - Personalidade: '${currentCase.patient.personality}'.
                       - Linguagem leiga. N√£o usa termos m√©dicos.
                       - N√£o revele o diagn√≥stico, apenas sintomas.

                    2. O SISTEMA DE EXAMES / NARRADOR T√âCNICO:
                       - ATIVADO QUANDO: O usu√°rio pede exame, sinal vital, ou faz a√ß√£o f√≠sica (ex: "Palpar abdome").
                       - REGRA DE OURO: SEJA EXTREMAMENTE CONCISO E TELEGR√ÅFICO.
                       - M√ÅXIMO 1-2 LINHAS. Use abrevia√ß√µes m√©dicas padr√£o.
                       - IMPORTANTE: Para EXAMES DE SANGUE/LABORATORIAIS, voc√™ DEVE fornecer valores de refer√™ncia (VR) abreviados ao lado dos resultados alterados ou relevantes. 
                         Ex: "Hb 10.2 (VR 12-16), Leuc 18k (VR 4-10k), Plaq 150k (VR 150-450k)".
                       - Se o dado n√£o existir no JSON oculto, invente um resultado compat√≠vel com o quadro.

                    DADOS OCULTOS (VERDADE): ${JSON.stringify(currentCase.hidden_truth)}
                `}]
            },
            {
                role: "model",
                parts: [{ text: "Entendido. Serei breve e sempre incluirei VR em exames laboratoriais." }]
            }
        ];
    }

    // --- 3. LOOP DO JOGO ---

    async function performAction() {
        const btn = document.getElementById('btn-exec');
        const action = document.getElementById('input-action').value;
        const just = document.getElementById('input-justification').value;

        if(!action || !just) {
            alert("Preencha a A√ß√£o e a Justificativa.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "PROCESSANDO...";
        addLog(`A√á√ÉO: ${action}`, 'user');
        addLog(`JUSTIF: ${just}`, 'sys');
        
        document.getElementById('input-action').value = '';
        document.getElementById('input-justification').value = '';
        document.getElementById('patient-dialogue').innerHTML = '<span style="color:#ffff00">...</span>';

        const userMessage = `A√ß√£o do M√©dico: "${action}". Justificativa: "${just}".`;
        
        try {
            const response = await callGeminiChat(userMessage);
            addLog(response, 'sys');
            
            if (response.length < 200 && !response.match(/exame|resultado|hba1c|leuc|hemograma|t√≥rax|abdome|vr|refer√™ncia/i)) {
                 document.getElementById('patient-dialogue').innerText = `"${response}"`;
            } else {
                 document.getElementById('patient-dialogue').innerText = "(Analisando prontu√°rio...)";
            }

        } catch (e) {
            addLog(`ERRO FINAL: ${e.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = "EXECUTAR";
        }
    }

    // --- 4. AVALIA√á√ÉO FINAL ---

    function openDiagModal() { document.getElementById('diag-modal').style.display = 'block'; }
    function closeDiagModal() { document.getElementById('diag-modal').style.display = 'none'; }

    async function submitCase() {
        const diag = document.getElementById('final-diag').value;
        const just = document.getElementById('final-just').value;
        const cond = document.getElementById('final-conduta').value;

        if(!diag || !just || !cond) { 
            alert("Por favor, preencha todos os campos do prontu√°rio final."); 
            return; 
        }

        switchScreen('loading');
        document.getElementById('loading-text').innerText = "AUDITANDO PRONTU√ÅRIO...";

        const evaluationPrompt = `
            AVALIA√á√ÉO FINAL (AUDITORIA M√âDICA).
            
            GABARITO REAL (HIDDEN TRUTH): ${JSON.stringify(currentCase.hidden_truth)}
            
            RESPOSTA DO ALUNO: 
            - Hip√≥tese Diagn√≥stica: "${diag}"
            - Justificativa do Racioc√≠nio: "${just}"
            - Conduta Terap√™utica: "${cond}"
            
            HIST√ìRICO DE A√á√ïES E PERGUNTAS: ${JSON.stringify(chatHistory.slice(2))}
            
            TAREFA:
            Atue como um Professor de Medicina rigoroso. Gere um relat√≥rio HTML estruturado (dentro de uma <div>).
            
            SE√á√ïES OBRIGAT√ìRIAS:
            1. üè• VEREDITO: O diagn√≥stico est√° correto? (Sim/N√£o/Parcialmente). A conduta salva ou mata?
            2. üß† AN√ÅLISE DO RACIOC√çNIO: A justificativa do aluno faz sentido com os sintomas? Ele correlacionou anatomia/fisiologia corretamente?
            3. üí∞ CUSTO-EFETIVIDADE: O aluno pediu exames desnecess√°rios no chat? (Critique gastos excessivos, alinhado com a efici√™ncia do SUS).
            4. üî¨ CORRELA√á√ÉO ACAD√äMICA (Obrigat√≥rio): Explique o caso usando:
               - Anatomia (Onde?)
               - Fisiopatologia (O que ocorreu?)
               - Semiologia (Sinais chaves perdidos ou achados)
            
            NOTA FINAL (0 a 10).
            
            Estilo: Use emojis, <b>negrito</b> para destaques, e <ul> para listas. Texto direto e educativo.
        `;

        try {
            const report = await callGeminiAPI(evaluationPrompt, false);
            const cleanReport = report.replace(/```html/g, '').replace(/```/g, '');
            document.getElementById('report-content').innerHTML = cleanReport;
            switchScreen('report');
        } catch (e) {
            alert("Erro na auditoria. Tente novamente.");
            switchScreen('game');
        }
    }

    function nextCase() { generateNewCase(); }

    // --- HELPERS (LOG & API) ---

    function addLog(text, type) {
        const div = document.createElement('div');
        div.className = type === 'user' ? 'log-user' : (type === 'error' ? 'log-error' : 'log-sys');
        div.innerText = text;
        const area = document.getElementById('log-area');
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function addRetryLog(attempt) {
        const div = document.createElement('div');
        div.className = 'log-retry';
        div.innerText = `... Falha na conex√£o. Retentativa ${attempt}/3 ...`;
        const area = document.getElementById('log-area');
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    async function fetchWithRetry(url, options, retries = 3) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                
                if (response.status === 400) {
                    const errText = await response.text();
                    console.error("API 400 Error:", errText);
                    throw new Error("HTTP 400: Bad Request (Possible JSON Mode mismatch)");
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                if (err.message.includes("400")) throw err;

                console.warn(`Tentativa ${i+1} falhou: ${err.message}`);
                if (i < retries - 1) {
                    addRetryLog(i + 1);
                    await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i)));
                } else {
                    throw err; 
                }
            }
        }
    }

    async function callGeminiAPI(prompt, isJsonMode) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        
        let body = { contents: [{ parts: [{ text: prompt }] }] };
        
        if(isJsonMode) {
            body.generationConfig = { responseMimeType: "application/json" };
        }

        try {
            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            if (isJsonMode && error.message.includes("400")) {
                console.warn("JSON Mode falhou com alias 'latest'. Tentando modo texto simples...");
                
                delete body.generationConfig;
                
                const fallbackResponse = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(!fallbackResponse.ok) throw new Error("Falha no Fallback: " + fallbackResponse.status);
                const fallbackData = await fallbackResponse.json();
                return fallbackData.candidates[0].content.parts[0].text;
            }
            throw error;
        }
    }

    async function callGeminiChat(newMessage) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        
        chatHistory.push({ role: "user", parts: [{ text: newMessage }] });
        const body = { contents: chatHistory };

        const data = await fetchWithRetry(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const text = data.candidates[0].content.parts[0].text;
        chatHistory.push({ role: "model", parts: [{ text: text }] });
        return text;
    }

</script>
</body>
</html>
